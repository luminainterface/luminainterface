<!DOCTYPE html>
<html>
<head>
    <title>{{ config.title }} - Language Module</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .language-status {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #1e2a3a;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .active {
            background-color: #27ae60;
            box-shadow: 0 0 10px #27ae60;
        }
        
        .inactive {
            background-color: #7f8c8d;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: #1e2a3a;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
        }
        
        .progress-container {
            width: 100%;
            background-color: #34495e;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 6px;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .chart-container {
            background: #1e2a3a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            height: 300px;
        }
        
        .chat-container {
            background: #1e2a3a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .user-message {
            background-color: #2c3e50;
            margin-left: 20px;
        }
        
        .system-message {
            background-color: #34495e;
            margin-right: 20px;
        }
        
        .message-meta {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .component-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .component-card {
            background: #1e2a3a;
            border-radius: 8px;
            padding: 15px;
        }
        
        .component-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #34495e;
        }
        
        .component-content {
            font-size: 14px;
        }
        
        .llm-weight-control {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }
        
        .slider-container {
            flex-grow: 1;
            margin: 0 15px;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #34495e;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
    </style>
    <script>
        const REFRESH_INTERVAL = 5000;
        let languageData = null;
        let metricsChart = null;
        let associationsChart = null;
        
        // Automatic refresh
        setInterval(() => {
            refreshLanguageData();
        }, REFRESH_INTERVAL);
        
        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            refreshLanguageData();
            
            // Set up LLM weight slider event
            const weightSlider = document.getElementById('llm-weight-slider');
            if (weightSlider) {
                weightSlider.addEventListener('change', updateLLMWeight);
            }
        });
        
        async function refreshLanguageData() {
            try {
                const response = await fetch('/api/visualization/language');
                languageData = await response.json();
                
                if (languageData.available === false) {
                    showUnavailableMessage();
                    return;
                }
                
                updateSystemStatus();
                updateMetrics();
                updateComponentStatus();
                updateConversationHistory();
                updateMetricsChart();
                updateAssociationsChart();
                
                // Update last refresh time
                document.getElementById('last-refresh').textContent = 
                    new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error refreshing language data:', error);
            }
        }
        
        function showUnavailableMessage() {
            const container = document.getElementById('language-container');
            container.innerHTML = `
                <div class="unavailable-message">
                    <h3>Language Module Data Unavailable</h3>
                    <p>Language module data is either inactive or not available.</p>
                </div>
            `;
        }
        
        function updateSystemStatus() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const modelInfo = document.getElementById('model-info');
            const llmWeight = document.getElementById('llm-weight-value');
            const nnWeight = document.getElementById('nn-weight-value');
            
            // Update status indicator
            if (languageData.active) {
                statusIndicator.classList.remove('inactive');
                statusIndicator.classList.add('active');
                statusText.textContent = 'ACTIVE';
            } else {
                statusIndicator.classList.remove('active');
                statusIndicator.classList.add('inactive');
                statusText.textContent = 'INACTIVE';
            }
            
            // Update model info
            if (languageData.model) {
                modelInfo.textContent = languageData.model;
            }
            
            // Update weights
            if (languageData.weights) {
                llmWeight.textContent = (languageData.weights.llm * 100).toFixed(0) + '%';
                nnWeight.textContent = (languageData.weights.nn * 100).toFixed(0) + '%';
                
                // Update slider
                const weightSlider = document.getElementById('llm-weight-slider');
                if (weightSlider) {
                    weightSlider.value = languageData.weights.llm;
                }
            }
        }
        
        function updateMetrics() {
            if (!languageData.metrics) return;
            
            // Define metrics to display
            const metrics = [
                { id: 'consciousness-level', label: 'Consciousness Level', key: 'consciousness_level', color: '#3498db' },
                { id: 'neural-score', label: 'Neural Score', key: 'neural_linguistic_score', color: '#2ecc71' },
                { id: 'pattern-depth', label: 'Recursive Pattern Depth', key: 'recursive_pattern_depth', color: '#e74c3c' },
                { id: 'memory-count', label: 'Memory Associations', key: 'memory_association_count', color: '#f39c12' },
                { id: 'exchanges', label: 'Total Exchanges', key: 'total_exchanges', color: '#9b59b6', isAbsolute: true },
                { id: 'concepts', label: 'Concepts Extracted', key: 'total_concepts', color: '#1abc9c', isAbsolute: true }
            ];
            
            // Update each metric
            metrics.forEach(metric => {
                const valueElement = document.getElementById(metric.id);
                const progressElement = document.getElementById(`${metric.id}-progress`);
                
                if (!valueElement || !progressElement) return;
                
                let value = languageData.metrics[metric.key] || 0;
                let displayValue;
                
                if (metric.isAbsolute) {
                    // For absolute number metrics
                    displayValue = value.toString();
                    progressElement.style.width = '100%';
                } else {
                    // For percentage metrics
                    displayValue = (value * 100).toFixed(0) + '%';
                    progressElement.style.width = `${value * 100}%`;
                }
                
                valueElement.textContent = displayValue;
                progressElement.style.backgroundColor = metric.color;
            });
        }
        
        function updateComponentStatus() {
            if (!languageData.components) return;
            
            const components = [
                { id: 'language-memory', key: 'language_memory' },
                { id: 'conscious-mirror', key: 'conscious_mirror_language' },
                { id: 'neural-processor', key: 'neural_linguistic_processor' },
                { id: 'pattern-analyzer', key: 'recursive_pattern_analyzer' },
                { id: 'database', key: 'database_manager' },
                { id: 'conv-memory', key: 'conversation_memory' },
                { id: 'mistral', key: 'mistral_integration' }
            ];
            
            components.forEach(component => {
                const statusElement = document.getElementById(`${component.id}-status`);
                if (!statusElement) return;
                
                const componentData = languageData.components[component.key];
                if (componentData) {
                    statusElement.textContent = componentData.active ? 'Active' : 'Inactive';
                    statusElement.style.color = componentData.active ? '#27ae60' : '#e74c3c';
                }
            });
        }
        
        function updateConversationHistory() {
            if (!languageData.conversations || !languageData.conversations.recent) return;
            
            const container = document.getElementById('conversation-container');
            container.innerHTML = '';
            
            // Add conversation messages
            const conversations = languageData.conversations.recent;
            conversations.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.is_user ? 'user-message' : 'system-message'}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.textContent = message.content;
                messageDiv.appendChild(contentDiv);
                
                const metaDiv = document.createElement('div');
                metaDiv.className = 'message-meta';
                
                // Format timestamp
                const timestamp = new Date(message.timestamp);
                const timeString = timestamp.toLocaleTimeString();
                
                metaDiv.textContent = `${message.is_user ? 'User' : 'System'} - ${timeString}`;
                
                // Add consciousness level if available and it's a system message
                if (!message.is_user && message.consciousness_level) {
                    const consciousnessSpan = document.createElement('span');
                    consciousnessSpan.textContent = ` | CL: ${(message.consciousness_level * 100).toFixed(0)}%`;
                    metaDiv.appendChild(consciousnessSpan);
                }
                
                messageDiv.appendChild(metaDiv);
                container.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        function updateMetricsChart() {
            if (!languageData.history || !languageData.history.metrics) return;
            
            const ctx = document.getElementById('metrics-chart').getContext('2d');
            const history = languageData.history.metrics;
            
            // Prepare data
            const labels = history.timestamps.map(ts => {
                const date = new Date(ts);
                return date.toLocaleTimeString();
            });
            
            const datasets = [
                {
                    label: 'Consciousness Level',
                    data: history.consciousness_level || [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Neural Score',
                    data: history.neural_linguistic_score || [],
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Recursive Pattern Depth',
                    data: history.recursive_pattern_depth || [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ];
            
            // Create or update chart
            if (!metricsChart) {
                metricsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1
                            }
                        }
                    }
                });
            } else {
                // Update existing chart
                metricsChart.data.labels = labels;
                metricsChart.data.datasets.forEach((dataset, i) => {
                    dataset.data = datasets[i].data;
                });
                metricsChart.update();
            }
        }
        
        function updateAssociationsChart() {
            if (!languageData.memory || !languageData.memory.top_associations) return;
            
            const ctx = document.getElementById('associations-chart').getContext('2d');
            const associations = languageData.memory.top_associations;
            
            // Prepare data
            const labels = associations.map(a => a.word);
            const data = associations.map(a => a.count);
            
            // Create or update chart
            if (!associationsChart) {
                associationsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Word Associations',
                            data: data,
                            backgroundColor: 'rgba(52, 152, 219, 0.6)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                // Update existing chart
                associationsChart.data.labels = labels;
                associationsChart.data.datasets[0].data = data;
                associationsChart.update();
            }
        }
        
        async function updateLLMWeight(event) {
            const newWeight = parseFloat(event.target.value);
            const weightValue = document.getElementById('llm-weight-value');
            
            // Update display immediately for responsiveness
            weightValue.textContent = (newWeight * 100).toFixed(0) + '%';
            
            try {
                // Send update to server
                const response = await fetch('/api/language/set-weight', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ weight: newWeight })
                });
                
                // Check if successful and refresh data
                if (response.ok) {
                    setTimeout(refreshLanguageData, 500);
                }
            } catch (error) {
                console.error('Error updating LLM weight:', error);
            }
        }
    </script>
</head>
<body>
    <div class="dashboard-header">
        <h1>{{ config.title }} - Language Module</h1>
        <div class="dashboard-info">
            <span>Last updated: <span id="last-refresh">-</span></span>
        </div>
    </div>
    
    <div class="dashboard-nav">
        <a href="/" class="nav-link">Dashboard</a>
        <a href="/dream-mode" class="nav-link">Dream Mode</a>
        <a href="/consciousness" class="nav-link">Consciousness</a>
        <a href="/language-module" class="nav-link active">Language Module</a>
    </div>
    
    <div class="dashboard-container" id="language-container">
        <!-- Language Module Status Section -->
        <div class="panel">
            <div class="panel-header">Language System Status</div>
            <div class="panel-content">
                <div class="language-status">
                    <div id="status-indicator" class="status-indicator inactive"></div>
                    <div id="status-text" class="dream-phase">INACTIVE</div>
                    <div style="margin-left: auto;">
                        <strong>Model:</strong> <span id="model-info">-</span>
                    </div>
                </div>
                
                <div class="llm-weight-control">
                    <div>
                        <strong>LLM Weight:</strong> <span id="llm-weight-value">50%</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" min="0" max="1" step="0.05" value="0.5" class="slider" id="llm-weight-slider">
                    </div>
                    <div>
                        <strong>NN Weight:</strong> <span id="nn-weight-value">50%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Language System Metrics Section -->
        <div class="panel">
            <div class="panel-header">Language System Metrics</div>
            <div class="panel-content">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Consciousness Level</div>
                        <div id="consciousness-level" class="metric-value">0%</div>
                        <div class="progress-container">
                            <div id="consciousness-level-progress" class="progress-bar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Neural Score</div>
                        <div id="neural-score" class="metric-value">0%</div>
                        <div class="progress-container">
                            <div id="neural-score-progress" class="progress-bar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Recursive Pattern Depth</div>
                        <div id="pattern-depth" class="metric-value">0%</div>
                        <div class="progress-container">
                            <div id="pattern-depth-progress" class="progress-bar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Memory Associations</div>
                        <div id="memory-count" class="metric-value">0%</div>
                        <div class="progress-container">
                            <div id="memory-count-progress" class="progress-bar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Exchanges</div>
                        <div id="exchanges" class="metric-value">0</div>
                        <div class="progress-container">
                            <div id="exchanges-progress" class="progress-bar" style="width:100%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Concepts Extracted</div>
                        <div id="concepts" class="metric-value">0</div>
                        <div class="progress-container">
                            <div id="concepts-progress" class="progress-bar" style="width:100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Component Status Section -->
        <div class="panel">
            <div class="panel-header">Component Status</div>
            <div class="panel-content">
                <div class="component-grid">
                    <div class="component-card">
                        <div class="component-header">Language Memory</div>
                        <div class="component-content">
                            Status: <span id="language-memory-status">Unknown</span>
                        </div>
                    </div>
                    <div class="component-card">
                        <div class="component-header">Conscious Mirror Language</div>
                        <div class="component-content">
                            Status: <span id="conscious-mirror-status">Unknown</span>
                        </div>
                    </div>
                    <div class="component-card">
                        <div class="component-header">Neural Linguistic Processor</div>
                        <div class="component-content">
                            Status: <span id="neural-processor-status">Unknown</span>
                        </div>
                    </div>
                    <div class="component-card">
                        <div class="component-header">Recursive Pattern Analyzer</div>
                        <div class="component-content">
                            Status: <span id="pattern-analyzer-status">Unknown</span>
                        </div>
                    </div>
                    <div class="component-card">
                        <div class="component-header">Database Manager</div>
                        <div class="component-content">
                            Status: <span id="database-status">Unknown</span>
                        </div>
                    </div>
                    <div class="component-card">
                        <div class="component-header">Conversation Memory</div>
                        <div class="component-content">
                            Status: <span id="conv-memory-status">Unknown</span>
                        </div>
                    </div>
                    <div class="component-card">
                        <div class="component-header">Mistral Integration</div>
                        <div class="component-content">
                            Status: <span id="mistral-status">Unknown</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Conversations Section -->
        <div class="panel">
            <div class="panel-header">Recent Conversations</div>
            <div class="panel-content">
                <div id="conversation-container" class="chat-container">
                    <div class="message system-message">
                        <div>No conversation history available</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Metrics History Chart -->
        <div class="panel">
            <div class="panel-header">Metrics History</div>
            <div class="panel-content">
                <div class="chart-container">
                    <canvas id="metrics-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Word Associations Chart -->
        <div class="panel">
            <div class="panel-header">Top Word Associations</div>
            <div class="panel-content">
                <div class="chart-container">
                    <canvas id="associations-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 